<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rich Text to Markdown Converter</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* LIGHT THEME */
            --bg-color: #f6f8fa;
            --text-color: #24292f;
            --input-bg: #ffffff;
            --border-color: #d0d7de;
            --accent-color: #1f883d;
            --accent-hover: #1a7f37;
            --btn-sec-bg: #f6f8fa;
            --btn-sec-hover: #eff1f3;
            --stats-bg: #f6f8fa;
            --stats-text: #57606a;
            --badge-bg: #eaeef2;
            --badge-text: #24292f;
            --shadow-color: rgba(0,0,0,0.05);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --preview-bg: #ffffff;
            --preview-text: #24292f;
            --preview-code-bg: #f6f8fa;
        }

        /* DARK THEME */
        [data-theme="dark"] {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --input-bg: #161b22;
            --border-color: #30363d;
            --accent-color: #238636;
            --accent-hover: #2ea043;
            --btn-sec-bg: #21262d;
            --btn-sec-hover: #30363d;
            --stats-bg: #161b22;
            --stats-text: #8b949e;
            /* Fixed Visibility for Dark Mode Pill */
            --badge-bg: #30363d; 
            --badge-text: #f0f6fc;
            --shadow-color: rgba(0,0,0,0.5);
            --modal-overlay: rgba(255, 255, 255, 0.1);
            --preview-bg: #0d1117;
            --preview-text: #c9d1d9;
            --preview-code-bg: #161b22;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        header { text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.5rem; }
        p { color: var(--stats-text); font-size: 0.9rem; margin-top: 5px; }

        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            min-height: 32px;
        }

        label { font-weight: 600; font-size: 0.9rem; }

        .text-box {
            flex: 1;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px 6px 0 0;
            padding: 15px;
            font-size: 14px;
            outline: none;
            overflow-y: auto;
            box-shadow: 0 1px 2px var(--shadow-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .text-box:focus {
            border-color: #0969da;
            box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
            z-index: 1;
        }

        #input-div {
            font-family: "Segoe UI", Helvetica, Arial, sans-serif;
            caret-color: var(--text-color);
        }
        
        textarea.text-box {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            resize: none;
        }

        #input-div[placeholder]:empty:before {
            content: attr(placeholder);
            color: var(--stats-text);
        }

        .stats-bar {
            background-color: var(--stats-bg);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 5px 10px;
            font-size: 0.75rem;
            color: var(--stats-text);
            text-align: right;
            font-family: monospace;
            flex-shrink: 0;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
            padding: 0 10px;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* UPDATED BADGE STYLES FOR VISIBILITY */
        .session-badge {
            background-color: var(--badge-bg);
            border: 1px solid var(--border-color);
            color: var(--badge-text); /* Improved contrast variable */
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            transition: 0.3s;
            max-width: 90vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .session-badge:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .attribution {
            color: var(--stats-text);
            font-size: 0.8rem;
        }

        .attribution a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 600;
        }
        .attribution a:hover { text-decoration: underline; color: var(--accent-color); }

        /* BUTTON STYLES */
        button, .file-btn {
            background-color: var(--btn-sec-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 5px 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: 0.2s;
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center; 
            font-family: inherit;
            line-height: normal;
        }

        button:hover, .file-btn:hover { 
            background-color: var(--btn-sec-hover); 
            border-color: #b9c0c6;
        }
        
        button.primary {
            background-color: var(--accent-color);
            color: white;
            border: 1px solid rgba(27, 31, 36, 0.15);
            box-shadow: 0 1px 0 rgba(27, 31, 36, 0.1);
            padding: 10px 20px;
            font-size: 14px;
        }
        button.primary:hover { background-color: var(--accent-hover); }

        .header-actions { display: flex; gap: 8px; }

        input[type="file"] { display: none; }

        /* CUSTOM MODAL STYLES */
        .modal-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-box {
            background: var(--input-bg);
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 650px; /* Widened for 4 columns */
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        /* PREVIEW CONTENT STYLING */
        #previewContent {
            text-align: left;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 6px;
            background-color: var(--preview-bg);
            color: var(--preview-text);
            overflow-x: auto;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
        }
        #previewContent h1, #previewContent h2, #previewContent h3 { 
            margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25;
            border-bottom: 1px solid var(--border-color); padding-bottom: .3em; color: var(--text-color);
        }
        #previewContent code { background: var(--preview-code-bg); padding: 0.2em 0.4em; border-radius: 6px; font-family: monospace; font-size: 85%; }
        #previewContent pre { background: var(--preview-code-bg); padding: 16px; overflow: auto; border-radius: 6px; margin-bottom: 16px; }
        #previewContent blockquote { border-left: 0.25em solid var(--border-color); padding: 0 1em; color: var(--stats-text); margin-bottom: 16px; }
        #previewContent img { max-width: 100%; }

        .modal-box h3 { margin-top: 0; color: var(--text-color); }
        .modal-box p { color: var(--stats-text); margin-bottom: 25px; }

        /* CHART & TABLE STYLES */
        .stats-grid {
            display: grid;
            /* 4 Columns for Words, Chars, Time, Generations */
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .stat-card .num { font-size: 1.1rem; font-weight: bold; color: var(--accent-color); display: block;}
        .stat-card .label { font-size: 0.7rem; color: var(--stats-text); }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-bottom: 15px;
        }

        .monthly-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 15px;
            color: var(--text-color);
        }
        .monthly-table th { text-align: left; padding: 8px; border-bottom: 1px solid var(--border-color); color: var(--stats-text);}
        .monthly-table td { padding: 8px; border-bottom: 1px solid var(--border-color); }
        .monthly-table tr:last-child td { border-bottom: none; }

        .modal-input {
            width: 100%; padding: 10px; margin-bottom: 20px;
            border: 1px solid var(--border-color); border-radius: 6px;
            background: var(--bg-color); color: var(--text-color);
            font-size: 14px; box-sizing: border-box;
        }
        .modal-input:focus { border-color: #0969da; outline: none; }

        .modal-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .modal-buttons button { padding: 10px 15px; font-size: 13px; flex: 1; justify-content: center; }

        /* THEME TOGGLE BUTTON */
        #themeToggle {
            position: fixed; bottom: 20px; right: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            background-color: var(--btn-sec-bg); border: 1px solid var(--border-color);
            color: var(--text-color); display: flex; align-items: center;
            justify-content: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; z-index: 999; padding: 0;
        }
        #themeToggle:hover { transform: scale(1.1); background-color: var(--btn-sec-hover); }
        #themeToggle svg { width: 20px; height: 20px; fill: currentColor; }

        @media (max-width: 768px) {
            body { height: auto; min-height: 100vh; }
            .container { flex-direction: column; height: auto; }
            .controls { flex-direction: row; padding: 20px 0; }
            .text-box { min-height: 300px; flex: none; }
            footer { margin-top: 40px; padding-bottom: 20px; }
            .header-actions { flex-wrap: wrap; justify-content: flex-end;}
            .modal-buttons { flex-direction: column; }
            #themeToggle { bottom: 15px; right: 15px; width: 40px; height: 40px; }
            .stats-grid { grid-template-columns: 1fr 1fr; } /* 2x2 grid on mobile */
        }
    </style>
</head>
<body>

    <header>
        <h1>Rich Text to Markdown</h1>
        <p>Paste formatted text (Word, Docs, Websites) to convert it.</p>
    </header>

    <div class="container">
        <div class="panel">
            <div class="label-row">
                <label for="input-div">Rich Text Input</label>
                <label for="fileUpload" class="file-btn">
                    Upload Files
                    <input type="file" id="fileUpload" accept=".txt,.html,.md,.htm" multiple>
                </label>
            </div>
            <div id="input-div" class="text-box" contenteditable="true" placeholder="Paste your bold, italic, or header text here..."></div>
            <div class="stats-bar" id="input-stats">0 words | 0 chars | 0 min read</div>
        </div>

        <div class="controls">
            <button class="primary" id="convertBtn">Convert &rarr;</button>
        </div>

        <div class="panel">
            <div class="label-row">
                <label for="output">Markdown Output</label>
                <div class="header-actions">
                    <button id="previewBtn">Preview</button>
                    <button id="downloadBtn">Download MD</button>
                    <button id="downloadHtmlBtn">Download HTML</button>
                    <button id="copyBtn">Copy</button>
                </div>
            </div>
            <textarea id="output" class="text-box" placeholder="Markdown will appear here..."></textarea>
            <div class="stats-bar" id="output-stats">0 words | 0 chars | 0 min read</div>
        </div>
    </div>

    <footer>
        <div class="session-badge" id="global-total" title="Click to view charts">
            Community Stats: Loading...
        </div>
        <div class="attribution">
            &copy; <span id="copyright-year"></span> Created by <a href="https://github.com/jackrschumacher" target="_blank">Jack Schumacher</a>. 
            View source on <a href="https://github.com/jackrschumacher/rich-txt-to-md" target="_blank">GitHub</a>.
        </div>
    </footer>

    <button id="themeToggle" title="Toggle Theme">
        <svg id="sunIcon" viewBox="0 0 24 24" style="display: none;">
            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
        </svg>
        <svg id="moonIcon" viewBox="0 0 24 24">
            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
        </svg>
    </button>

    <div id="previewModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px;">
            <h3>Preview</h3>
            <div id="previewContent"></div>
            <div class="modal-buttons">
                <button id="btnClosePreview">Close</button>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Community Statistics</h3>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="num" id="modalWords">0</span>
                    <span class="label">Words</span>
                </div>
                <div class="stat-card">
                    <span class="num" id="modalChars">0</span>
                    <span class="label">Chars</span>
                </div>
                <div class="stat-card">
                    <span class="num" id="modalTime">0</span>
                    <span class="label">Time to Read</span>
                </div>
                <div class="stat-card">
                    <span class="num" id="modalGens">0</span>
                    <span class="label">Conversions</span>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="statsChart"></canvas>
            </div>

            <p style="text-align: left; margin-bottom: 5px; font-weight: 600; color: var(--text-color);">History by Month</p>
            <div style="max-height: 200px; overflow-y: auto;">
                <table class="monthly-table">
                    <thead>
                        <tr><th>Month</th><th>Words</th><th>Chars</th><th>Time</th><th>Conversions</th></tr>
                    </thead>
                    <tbody id="monthlyTableBody">
                        <tr><td colspan="5">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button id="btnCloseStats">Close</button>
            </div>
        </div>
    </div>

    <div id="multiFileModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Multiple Files Detected</h3>
            <p id="multiFileMessage">How would you like to handle these files?</p>
            <div class="modal-buttons">
                <button id="btnCombine" class="primary">Combine All</button>
                <button id="btnBatch">Keep Original Names</button>
                <button id="btnRename">Rename Each</button>
            </div>
        </div>
    </div>

    <div id="filenameModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Save File</h3>
            <p>Confirm or rename your file before downloading.</p>
            <input type="text" id="filenameInput" class="modal-input" placeholder="Enter filename...">
            <div class="modal-buttons">
                <button id="btnSaveFile" class="primary">Download</button>
                <button id="btnCancelFile">Cancel</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="alertTitle">Notice</h3>
            <p id="alertMessage">Message goes here.</p>
            <div class="modal-buttons">
                <button id="btnAlertOk" class="primary">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwtLS23NF7HoMRKlUusW_vq8I8L7o3GZc",
            authDomain: "rich-text-to-md.firebaseapp.com",
            databaseURL: "https://rich-text-to-md-default-rtdb.firebaseio.com",
            projectId: "rich-text-to-md",
            storageBucket: "rich-text-to-md.firebasestorage.app",
            messagingSenderId: "447372975808",
            appId: "1:447372975808:web:f1c92def8181de88251725"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statsRef = ref(db, 'community_stats'); 
        const globalBadge = document.getElementById('global-total');

        // STATS UI ELEMENTS
        const statsModal = document.getElementById('statsModal');
        const btnCloseStats = document.getElementById('btnCloseStats');
        const monthlyTableBody = document.getElementById('monthlyTableBody');
        const modalWords = document.getElementById('modalWords');
        const modalChars = document.getElementById('modalChars');
        const modalTime = document.getElementById('modalTime');
        const modalGens = document.getElementById('modalGens');
        let statsChartInstance = null;

        // 1. LISTENER FOR BADGE (Total)
        onValue(child(statsRef, 'total'), (snapshot) => {
            const data = snapshot.val() || { words: 0, chars: 0, read_time: 0, generations: 0 };
            
            const words = (data.words || 0).toLocaleString();
            const chars = (data.chars || 0).toLocaleString();
            const gens = (data.generations || 0).toLocaleString();
            let timeDisplay = (data.read_time || 0) + " min";
            if ((data.read_time || 0) > 60) {
                timeDisplay = Math.floor((data.read_time || 0) / 60) + " hr " + ((data.read_time || 0) % 60) + " min";
            }

            // Updated Pill Text (Shortened slightly to fit)
            globalBadge.innerText = `Total: ${words} words • ${gens} conversions • ${timeDisplay} read time`;
            
            // Update Modal Cards
            modalWords.innerText = words;
            modalChars.innerText = chars;
            modalTime.innerText = timeDisplay;
            modalGens.innerText = gens;
        });

        // 2. WRITE LOGIC (Includes Generations +1)
        window.incrementGlobalCount = function(w, c, t) {
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const updateFunc = (current) => {
                if (!current) return { words: w, chars: c, read_time: t, generations: 1 };
                return {
                    words: (current.words || 0) + w,
                    chars: (current.chars || 0) + c,
                    read_time: (current.read_time || 0) + t,
                    generations: (current.generations || 0) + 1
                };
            };

            runTransaction(child(statsRef, 'total'), updateFunc);
            runTransaction(child(statsRef, `monthly/${monthKey}`), updateFunc).then(() => {
                globalBadge.style.backgroundColor = "#d1fae5";
                setTimeout(() => globalBadge.style.backgroundColor = "#eaeef2", 300);
            });
        }

        // 3. RENDER CHART & TABLE
        globalBadge.addEventListener('click', () => {
            statsModal.style.display = 'flex';
            monthlyTableBody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

            get(child(statsRef, 'monthly')).then((snapshot) => {
                if (snapshot.exists()) {
                    const monthlyData = snapshot.val();
                    const sortedMonths = Object.keys(monthlyData).sort(); 
                    
                    const labels = [];
                    const wordsData = [];
                    const charsData = [];
                    const timeData = [];

                    let tableHtml = '';
                    // Loop reversed for Table (Newest first)
                    [...sortedMonths].reverse().forEach(key => {
                        const m = monthlyData[key];
                        const rTime = m.read_time || 0;
                        tableHtml += `<tr>
                            <td>${key}</td>
                            <td>${(m.words || 0).toLocaleString()}</td>
                            <td>${(m.chars || 0).toLocaleString()}</td>
                            <td>${rTime.toLocaleString()} m</td>
                            <td>${(m.generations || 0).toLocaleString()}</td>
                        </tr>`;
                    });
                    monthlyTableBody.innerHTML = tableHtml;

                    // Prepare Chart Data
                    sortedMonths.forEach(key => {
                        labels.push(key);
                        wordsData.push(monthlyData[key].words || 0);
                        charsData.push(monthlyData[key].chars || 0);
                        timeData.push(monthlyData[key].read_time || 0);
                    });

                    // Get Current Theme Colors
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const textColor = isDark ? '#c9d1d9' : '#57606a';
                    const gridColor = isDark ? '#30363d' : '#e1e4e8';

                    // Render Chart
                    const ctx = document.getElementById('statsChart').getContext('2d');
                    if (statsChartInstance) statsChartInstance.destroy();

                    statsChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Words',
                                    data: wordsData,
                                    backgroundColor: 'rgba(31, 136, 61, 0.7)', /* Green */
                                    yAxisID: 'y',
                                },
                                {
                                    label: 'Characters',
                                    data: charsData,
                                    backgroundColor: 'rgba(210, 153, 34, 0.7)', /* Orange */
                                    yAxisID: 'y',
                                },
                                {
                                    label: 'Time to Read',
                                    data: timeData,
                                    borderColor: '#0969da', /* Blue */
                                    backgroundColor: 'rgba(9, 105, 218, 0.1)',
                                    type: 'line',
                                    yAxisID: 'y1',
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { ticks: { color: textColor }, grid: { color: gridColor } },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'Volume', color: textColor },
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'Minutes', color: '#0969da' },
                                    grid: { drawOnChartArea: false },
                                    ticks: { color: '#0969da' }
                                }
                            },
                            plugins: {
                                legend: { labels: { color: textColor } }
                            }
                        }
                    });

                } else {
                    monthlyTableBody.innerHTML = '<tr><td colspan="5">No history yet.</td></tr>';
                }
            }).catch((e) => {
                console.error(e);
                monthlyTableBody.innerHTML = '<tr><td colspan="5">Error loading data.</td></tr>';
            });
        });

        btnCloseStats.onclick = () => { statsModal.style.display = 'none'; }
    </script>

    <script>
        document.getElementById('copyright-year').innerText = new Date().getFullYear();

        var turndownService = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });
        
        if (typeof marked !== 'undefined') {
            marked.use({ breaks: true, gfm: true });
        }

        const inputDiv = document.getElementById('input-div');
        const output = document.getElementById('output');
        const convertBtn = document.getElementById('convertBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadHtmlBtn = document.getElementById('downloadHtmlBtn');
        const previewBtn = document.getElementById('previewBtn');
        const fileUpload = document.getElementById('fileUpload');
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        
        // Modals
        const multiFileModal = document.getElementById('multiFileModal');
        const filenameModal = document.getElementById('filenameModal');
        const alertModal = document.getElementById('alertModal');
        const previewModal = document.getElementById('previewModal');
        const previewContent = document.getElementById('previewContent');
        const btnClosePreview = document.getElementById('btnClosePreview');
        
        const btnCombine = document.getElementById('btnCombine');
        const btnBatch = document.getElementById('btnBatch');
        const btnRename = document.getElementById('btnRename');
        const multiFileMessage = document.getElementById('multiFileMessage');
        
        const filenameInput = document.getElementById('filenameInput');
        const btnSaveFile = document.getElementById('btnSaveFile');
        const btnCancelFile = document.getElementById('btnCancelFile');

        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const btnAlertOk = document.getElementById('btnAlertOk');

        let lastSubmittedText = null;
        let currentFilename = "Rich text to markdown convert.md";
        
        let modalResolve = null;
        let alertResolve = null;

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            } else {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            }
            localStorage.setItem('theme', theme);
        }

        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            setTheme(systemPrefersDark ? 'dark' : 'light');
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        function getWordCount(text) {
            return text.trim().split(/\s+/).filter(w => w.length > 0).length;
        }
        
        function getReadTime(wordCount) {
            if (wordCount <= 0) return 0;
            return Math.ceil(wordCount / 225);
        }

        function updateStats(text, elementId) {
            const charCount = text.length;
            const wordCount = getWordCount(text);
            const readTime = getReadTime(wordCount);
            const timeString = readTime === 0 ? "0 min read" : `~${readTime} min read`;
            document.getElementById(elementId).innerText = `${wordCount} words | ${charCount} chars | ${timeString}`;
        }

        function convert() {
            const htmlContent = inputDiv.innerHTML;
            const plainText = inputDiv.innerText; 
            const markdown = turndownService.turndown(htmlContent);
            output.value = markdown;
            updateStats(plainText, 'input-stats');
            updateStats(markdown, 'output-stats');
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;
                    let processedContent = "";
                    if (file.name.toLowerCase().endsWith('.html') || file.name.toLowerCase().endsWith('.htm')) {
                        processedContent = content;
                    } else {
                        processedContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
                    }
                    resolve(processedContent);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // MODAL LOGIC
        btnSaveFile.onclick = function() {
            if (modalResolve) {
                modalResolve(filenameInput.value.trim());
                filenameModal.style.display = 'none';
                modalResolve = null;
            }
        };
        btnCancelFile.onclick = function() {
            if (modalResolve) {
                modalResolve(null);
                filenameModal.style.display = 'none';
                modalResolve = null;
            }
        };
        filenameInput.onkeydown = function(e) {
            if(e.key === 'Enter') btnSaveFile.click();
        };

        function askFileName(defaultName) {
            return new Promise((resolve) => {
                filenameInput.value = defaultName;
                filenameModal.style.display = 'flex';
                filenameInput.focus();
                modalResolve = resolve;
            });
        }

        btnAlertOk.onclick = function() {
            if (alertResolve) {
                alertResolve();
                alertModal.style.display = 'none';
                alertResolve = null;
            }
        };

        function showAlert(title, message) {
            return new Promise((resolve) => {
                alertTitle.innerText = title;
                alertMessage.innerText = message;
                alertModal.style.display = 'flex';
                alertResolve = resolve;
            });
        }

        function triggerDownload(filename, content, mimeType) {
            processAction(content); 
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        async function handleFiles(files, mode) {
            if (mode === "combine") {
                currentFilename = "Combined Uploads.md";
                const filePromises = files.map(file => readFileAsText(file));
                const contents = await Promise.all(filePromises);
                inputDiv.innerHTML = contents.join('<br><br><hr><br><br>');
                convert();
            
            } else if (mode === "batch") {
                await showAlert("Download Permission", "Note: You may need to grant permission for your browser to download multiple files.");
                for (const file of files) {
                    const content = await readFileAsText(file);
                    inputDiv.innerHTML = content;
                    convert();
                    await new Promise(r => setTimeout(r, 300));
                    let filename = file.name.replace(/\.[^/.]+$/, "") + ".md";
                    triggerDownload(filename, output.value, 'text/markdown');
                }
                await showAlert("Complete", "Batch processing complete!");

            } else if (mode === "rename") {
                for (const file of files) {
                    const content = await readFileAsText(file);
                    inputDiv.innerHTML = content;
                    convert();
                    await new Promise(r => setTimeout(r, 100)); 
                    const defaultName = file.name.replace(/\.[^/.]+$/, "") + ".md";
                    const filename = await askFileName(defaultName);
                    if (filename) {
                        let safeName = filename;
                        if (!safeName.toLowerCase().endsWith('.md')) safeName += ".md";
                        triggerDownload(safeName, output.value, 'text/markdown');
                    }
                }
                await showAlert("Complete", "Interactive processing complete!");
            }
        }

        fileUpload.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            if (files.length === 1) {
                handleFiles(files, 'combine');
            } else {
                multiFileMessage.innerText = `You selected ${files.length} files. How would you like to handle them?`;
                multiFileModal.style.display = 'flex';
                btnCombine.onclick = function() {
                    multiFileModal.style.display = 'none';
                    handleFiles(files, 'combine');
                };
                btnBatch.onclick = function() {
                    multiFileModal.style.display = 'none';
                    handleFiles(files, 'batch');
                };
                btnRename.onclick = function() {
                    multiFileModal.style.display = 'none';
                    handleFiles(files, 'rename');
                };
            }
        });

        convertBtn.addEventListener('click', convert);
        let timeout = null;
        inputDiv.addEventListener('input', () => {
            updateStats(inputDiv.innerText, 'input-stats');
            clearTimeout(timeout);
            timeout = setTimeout(convert, 500);
        });

        function processAction(text) {
            if (!text) return false;
            if (text !== lastSubmittedText) {
                const w = getWordCount(text);
                const c = text.length;
                const t = getReadTime(w);
                if(window.incrementGlobalCount) window.incrementGlobalCount(w, c, t);
                lastSubmittedText = text;
            }
            return true;
        }

        downloadBtn.addEventListener('click', async () => {
            const text = output.value;
            if (!text) return;
            const defaultName = currentFilename.replace(/\.html$/, ".md");
            const filename = await askFileName(defaultName);
            if (filename) {
                let safeName = filename;
                if (!safeName.toLowerCase().endsWith('.md')) safeName += ".md";
                triggerDownload(safeName, text, 'text/markdown');
            }
        });

        downloadHtmlBtn.addEventListener('click', async () => {
            const content = inputDiv.innerHTML;
            if (!content) return;
            const htmlFile = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Exported Content</title><style>body{font-family:sans-serif;line-height:1.6;padding:20px;max-width:800px;margin:0 auto;}</style></head><body>${content}</body></html>`;
            const defaultName = currentFilename.replace(/\.md$/, ".html");
            const filename = await askFileName(defaultName);
            if (filename) {
                let safeName = filename;
                if (!safeName.toLowerCase().endsWith('.html')) safeName += ".html";
                triggerDownload(safeName, htmlFile, 'text/html');
            }
        });

        previewBtn.addEventListener('click', () => {
            const markdownText = output.value;
            if (!markdownText) return;
            const htmlPreview = marked.parse(markdownText);
            previewContent.innerHTML = htmlPreview;
            previewModal.style.display = 'flex';
        });

        btnClosePreview.onclick = () => {
            previewModal.style.display = 'none';
        };

        copyBtn.addEventListener('click', () => {
            const text = output.value;
            if (!processAction(text)) return;
            output.select();
            document.execCommand('copy');
            const originalText = copyBtn.innerText;
            copyBtn.innerText = "Copied!";
            setTimeout(() => copyBtn.innerText = originalText, 2000);
        });
    </script>
</body>
</html>